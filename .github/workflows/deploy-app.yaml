name: Deploy Application

on:
  # Trigger on pushes to main that modify app deployments
  push:
    branches:
      - main
    paths:
      - 'k8s/apps/**'
      - '.github/workflows/deploy-app.yaml'

  # Allow manual triggering with custom parameters
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name (DNS label format)'
        required: true
        type: string
      subdomain:
        description: 'Subdomain (will be SUBDOMAIN.pane.run)'
        required: true
        type: string
      container_image:
        description: 'Container image to deploy (e.g., nginx:latest)'
        required: true
        type: string
      container_port:
        description: 'Container port to expose'
        required: true
        type: string
      replicas:
        description: 'Number of replicas'
        required: false
        type: string
        default: '2'

env:
  # Set default values for auto-detected deployments
  # These are overridden by workflow_dispatch inputs
  DEFAULT_REPLICAS: 2

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need 2 commits to detect changes

      - name: Detect changed app (on push)
        if: github.event_name == 'push'
        id: detect-app
        run: |
          # Find which app directory was modified
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Extract app name from path k8s/apps/{app_name}/*
          APP_PATH=$(echo "$CHANGED_FILES" | grep '^k8s/apps/' | head -n 1)

          if [[ -z "$APP_PATH" ]]; then
            echo "No app changes detected in k8s/apps/"
            exit 1
          fi

          APP_NAME=$(echo "$APP_PATH" | cut -d'/' -f3)
          echo "Detected app: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

          # Read deployment configuration from the app's deployment.yaml
          DEPLOYMENT_FILE="k8s/apps/$APP_NAME/deployment.yaml"

          if [[ ! -f "$DEPLOYMENT_FILE" ]]; then
            echo "Error: $DEPLOYMENT_FILE not found"
            exit 1
          fi

          # Extract values from YAML
          CONTAINER_IMAGE=$(grep -A 10 'containers:' "$DEPLOYMENT_FILE" | grep 'image:' | head -n 1 | awk '{print $2}')
          CONTAINER_PORT=$(grep -A 10 'containers:' "$DEPLOYMENT_FILE" | grep 'containerPort:' | head -n 1 | awk '{print $2}')
          REPLICAS=$(grep 'replicas:' "$DEPLOYMENT_FILE" | awk '{print $2}')

          echo "container_image=$CONTAINER_IMAGE" >> $GITHUB_OUTPUT
          echo "container_port=$CONTAINER_PORT" >> $GITHUB_OUTPUT
          echo "replicas=${REPLICAS:-$DEFAULT_REPLICAS}" >> $GITHUB_OUTPUT

          # Read subdomain from ingressroute.yaml
          INGRESSROUTE_FILE="k8s/apps/$APP_NAME/ingressroute.yaml"

          if [[ ! -f "$INGRESSROUTE_FILE" ]]; then
            echo "Error: $INGRESSROUTE_FILE not found"
            exit 1
          fi

          SUBDOMAIN=$(grep 'Host(' "$INGRESSROUTE_FILE" | sed -E 's/.*Host\(`([^.]+)\.pane\.run`\).*/\1/')

          echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT

          # Print summary
          echo "Configuration detected:"
          echo "  App Name: $APP_NAME"
          echo "  Subdomain: $SUBDOMAIN.pane.run"
          echo "  Image: $CONTAINER_IMAGE"
          echo "  Port: $CONTAINER_PORT"
          echo "  Replicas: ${REPLICAS:-$DEFAULT_REPLICAS}"

      - name: Set deployment parameters
        id: params
        run: |
          # Use workflow_dispatch inputs if available, otherwise use detected values
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "app_name=${{ github.event.inputs.app_name }}" >> $GITHUB_OUTPUT
            echo "subdomain=${{ github.event.inputs.subdomain }}" >> $GITHUB_OUTPUT
            echo "container_image=${{ github.event.inputs.container_image }}" >> $GITHUB_OUTPUT
            echo "container_port=${{ github.event.inputs.container_port }}" >> $GITHUB_OUTPUT
            echo "replicas=${{ github.event.inputs.replicas }}" >> $GITHUB_OUTPUT
          else
            echo "app_name=${{ steps.detect-app.outputs.app_name }}" >> $GITHUB_OUTPUT
            echo "subdomain=${{ steps.detect-app.outputs.subdomain }}" >> $GITHUB_OUTPUT
            echo "container_image=${{ steps.detect-app.outputs.container_image }}" >> $GITHUB_OUTPUT
            echo "container_port=${{ steps.detect-app.outputs.container_port }}" >> $GITHUB_OUTPUT
            echo "replicas=${{ steps.detect-app.outputs.replicas }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

          # Verify connection
          kubectl cluster-info
          kubectl get nodes

      - name: Run deployment script
        id: deploy
        run: |
          ./scripts/deploy-app.sh \
            --name "${{ steps.params.outputs.app_name }}" \
            --subdomain "${{ steps.params.outputs.subdomain }}" \
            --image "${{ steps.params.outputs.container_image }}" \
            --port "${{ steps.params.outputs.container_port }}" \
            --replicas "${{ steps.params.outputs.replicas }}"

      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application**: ${{ steps.params.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://${{ steps.params.outputs.subdomain }}.pane.run" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: ${{ steps.params.outputs.container_image }}" >> $GITHUB_STEP_SUMMARY
          echo "**Replicas**: ${{ steps.params.outputs.replicas }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n ${{ steps.params.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n ${{ steps.params.outputs.app_name }} -l app=${{ steps.params.outputs.app_name }} --tail=100 -f" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application**: ${{ steps.params.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Subdomain**: ${{ steps.params.outputs.subdomain }}.pane.run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n ${{ steps.params.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "kubectl describe deployment ${{ steps.params.outputs.app_name }} -n ${{ steps.params.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n ${{ steps.params.outputs.app_name }} -l app=${{ steps.params.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
