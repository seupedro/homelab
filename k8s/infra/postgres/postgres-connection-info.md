# PostgreSQL Connection Information

## PostgreSQL 18 (storage namespace)

### Cluster Status
- **Namespace**: `storage`
- **Cluster Name**: `postgresql`
- **Pod**: `postgresql-1`
- **Version**: PostgreSQL 18.0
- **Storage**: 8Gi on local-path
- **Status**: ✅ Healthy

### Services
- **Read-Write**: `postgresql-rw.storage.svc.cluster.local:5432`
- **Read**: `postgresql-r.storage.svc.cluster.local:5432`
- **Read-Only**: `postgresql-ro.storage.svc.cluster.local:5432` (no endpoints - single instance)

### Credentials
- **Superuser**: `postgres`
- **Password Secret**: `postgresql-superuser` (in `storage` namespace)
- **Default Database**: `defaultdb`

### Connection Examples

#### From within the cluster:
```bash
# Get the password
PGPASSWORD=$(kubectl get secret postgresql-superuser -n storage -o jsonpath='{.data.password}' | base64 -d)

# Connect using psql
psql -h postgresql-rw.storage.svc.cluster.local -U postgres -d defaultdb

# Connection URI
postgresql://postgres:<password>@postgresql-rw.storage.svc.cluster.local:5432/defaultdb
```

#### Local connection (exec into pod):
```bash
kubectl exec -it postgresql-1 -n storage -- psql -U postgres -d defaultdb
```

---

## PostgreSQL 16 (postgres-16 namespace)

### Cluster Status
- **Namespace**: `postgres-16`
- **Cluster Name**: `postgres-16`
- **Pod**: `postgres-16-1`
- **Version**: PostgreSQL 16.11
- **Storage**: 50Gi on local-path
- **Status**: ✅ Healthy

### Services
- **Read-Write**: `postgres-16-rw.postgres-16.svc.cluster.local:5432`
- **Read**: `postgres-16-r.postgres-16.svc.cluster.local:5432`
- **Read-Only**: `postgres-16-ro.postgres-16.svc.cluster.local:5432` (no endpoints - single instance)

### Credentials

#### Superuser (postgres)
- **User**: `postgres`
- **Password Secret**: `postgres-16-superuser` (in `postgres-16` namespace)
- **Database**: `app` (default)

#### Application User
- **User**: `app`
- **Password Secret**: `postgres-16-credentials` (in `postgres-16` namespace)
- **Database**: `app`
- **Owner**: Owns the `app` database

### Connection Examples

#### From within the cluster (superuser):
```bash
# Get the superuser password
PGPASSWORD=$(kubectl get secret postgres-16-superuser -n postgres-16 -o jsonpath='{.data.password}' | base64 -d)

# Connect using psql
psql -h postgres-16-rw.postgres-16.svc.cluster.local -U postgres -d app
```

#### From within the cluster (app user):
```bash
# Get the app password
PGPASSWORD=$(kubectl get secret postgres-16-credentials -n postgres-16 -o jsonpath='{.data.password}' | base64 -d)

# Connect using psql
psql -h postgres-16-rw.postgres-16.svc.cluster.local -U app -d app
```

#### Local connection (exec into pod):
```bash
kubectl exec -it postgres-16-1 -n postgres-16 -- psql -U postgres -d app
```

---

## Quick Health Check

Run this command to check both clusters:
```bash
kubectl get cluster -A
```

Expected output:
```
NAMESPACE    NAME         AGE   INSTANCES   READY   STATUS                     PRIMARY
storage      postgresql   ...   1           1       Cluster in healthy state   postgresql-1
postgres-16  postgres-16  ...   1           1       Cluster in healthy state   postgres-16-1
```

---

## Testing Connections

### Test PostgreSQL 18
```bash
kubectl exec postgresql-1 -n storage -- psql -U postgres -d defaultdb -c "SELECT 'PostgreSQL 18 is working!' as status, version();"
```

### Test PostgreSQL 16
```bash
kubectl exec postgres-16-1 -n postgres-16 -- psql -U postgres -d app -c "SELECT 'PostgreSQL 16 is working!' as status, version();"
```

---

## Configuration Files

- **PostgreSQL 16 Manifests**: `/home/seupedro/homelab/k8s/postgres-16/`
  - `namespace.yaml` - Namespace definition
  - `cluster.yaml` - CloudNative-PG cluster configuration

---

## Operator Information

Both clusters are managed by **CloudNative-PG operator v1.27.1**

- **Operator Namespace**: `cnpg-system`
- **Operator Pod**: Check with `kubectl get pods -n cnpg-system`

---

## Notes

1. **Single Instance Clusters**: Both deployments are single-instance clusters. The `-ro` (read-only) services will not have endpoints until replicas are added.

2. **Superuser Access**: Both clusters have `enableSuperuserAccess: true`, which allows the operator to manage the postgres user password automatically.

3. **Storage**:
   - PostgreSQL 18: 8Gi
   - PostgreSQL 16: 50Gi
   Both use the `local-path` storage class.

4. **Security**: Passwords are stored in Kubernetes secrets and are automatically generated by the operator.

5. **Backup**: Currently no backup is configured. Consider setting up WAL archiving and scheduled backups for production use.
