# OAuth2-Proxy Helm Chart Values for Headlamp
# Documentation: https://oauth2-proxy.github.io/manifests/

# Configuration
config:
    # OIDC Provider
    provider: "oidc"
    oidcIssuerUrl: "https://zitadel.pane.run"

    # Client credentials
    clientID: "347751017762324680"
    clientSecret: "not-used-with-pkce" # PKCE doesn't use client secret, but field is required

    # Redirect configuration (REQUIRED)
    # In reverse proxy mode, use the actual application domain
    redirectUrl: "https://headlamp.pane.run/oauth2/callback"

    # Whitelist domains (REQUIRED - allows redirects to these domains)
    whitelistDomains:
        - ".pane.run"

    # Cookie configuration
    cookieName: "_oauth2-proxy-headlamp"
    cookieSecret: "Xp4K8vN2mR9wJ5yT7qL3hB6sF1dG0zA8uM4cE2nV5iO="
    cookieSecure: true
    cookieHttpOnly: true
    cookieSameSite: "lax"
    cookieExpire: "168h" # 7 days
    cookieRefresh: "60m" # Refresh token every hour

    # PKCE support
    codeChallengMethod: "S256"

    # Scopes to request
    scope: "openid profile email"

    # Email domain restrictions (allow all)
    emailDomains:
        - "*"

    # Upstream (Reverse Proxy mode - proxy to headlamp after authentication)
    upstreams:
        - "http://headlamp.headlamp.svc.cluster.local:80"

    # Skip provider CA verification (Let's Encrypt is trusted)
    skipProviderCAVerification: false

    # Pass auth headers to upstream
    setXAuthRequest: true
    setAuthorizationHeader: true
    passAccessToken: true
    passUserHeaders: true

    # Reverse proxy settings
    reverseProxy: true

    # Whitelist healthcheck paths
    skipAuthRoutes:
        - "GET=/ping"
        - "GET=/ready"

# Service configuration
service:
    type: ClusterIP
    portNumber: 80
    targetPort: 4180

# Resource limits
resources:
    limits:
        cpu: 200m
        memory: 256Mi
    requests:
        cpu: 100m
        memory: 128Mi

# Replica count
replicaCount: 1

# Probes
livenessProbe:
    enabled: true
    initialDelaySeconds: 10
    timeoutSeconds: 5

readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    timeoutSeconds: 5

# Disable built-in ingress (we'll use Traefik IngressRoute)
ingress:
    enabled: false

# Session storage (in-memory for single replica)
sessionStorage:
    type: cookie

# Extra arguments
extraArgs:
    # Provider configuration
    provider: "oidc"
    oidc-issuer-url: "https://zitadel.pane.run"
    redirect-url: "https://headlamp.pane.run/oauth2/callback"

    # OIDC claims
    oidc-email-claim: "email"
    oidc-groups-claim: "groups"

    # Other settings
    skip-jwt-bearer-tokens: true
    skip-auth-strip-headers: false

    # Reverse proxy settings
    reverse-proxy: true
    pass-access-token: true
    pass-user-headers: true
    set-xauthrequest: true
    set-authorization-header: true

    # Cookie settings
    cookie-name: "_oauth2-proxy-headlamp"
    cookie-secure: true
    cookie-httponly: true
    cookie-samesite: "lax"
    cookie-expire: "168h"
    cookie-refresh: "60m"

    # PKCE
    code-challenge-method: "S256"

    # Scope
    scope: "openid profile email"

    # Whitelist
    whitelist-domain: ".pane.run"

    # Upstream - proxy to headlamp service after authentication
    upstream: "http://headlamp.headlamp.svc.cluster.local:80"
