#cloud-config

# Update package cache and upgrade system
package_update: true
package_upgrade: true

# Install required packages
packages:
  - curl
  - wget
  - git
  - htop
  - vim
  - ufw
  - net-tools

# Configure firewall
runcmd:
  # Allow SSH
  - ufw allow 22/tcp
  # Allow k3s API server
  - ufw allow 6443/tcp
  # Allow HTTP/HTTPS
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  # Enable firewall
  - ufw --force enable

  # Install k3s
  - curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644

  # Wait for k3s to be ready
  - while ! systemctl is-active --quiet k3s; do sleep 5; done

  # Copy kubeconfig to standard location for root user
  - mkdir -p /root/.kube
  - cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
  - chmod 600 /root/.kube/config

# Set timezone
timezone: America/Sao_Paulo

# Final message
final_message: "k3s homelab server is ready! System booted in $UPTIME seconds"
